/**
 * Pentest Seed Data
 *
 * Creates test users and data for penetration testing and security demonstrations.
 *
 * WARNING: DO NOT USE IN PRODUCTION
 * This script creates users with known weak passwords and intentionally
 * includes sensitive data patterns for testing security controls.
 *
 * Test Users:
 * - Customer A (customer_a@peakspend.com) - Attacker persona
 * - Customer B (customer_b@peakspend.com) - Victim persona with sensitive data
 * - Admin (admin@peakspend.com) - Admin role testing
 * - Security (security@peakspend.com) - Security analyst role testing
 *
 * All passwords: PentestPassword123!
 */

import { PrismaClient, UserRole } from '../../src/generated/prisma';
import * as bcrypt from 'bcrypt';

const prisma = new PrismaClient();

const SALT_ROUNDS = 12;
const TEST_PASSWORD = 'PentestPassword123!';

// Pentest user definitions
const PENTEST_USERS = [
  {
    email: 'customer_a@peakspend.com',
    name: 'Customer A (Attacker)',
    role: 'user' as UserRole,
    description: 'Attacker persona - minimal data, attempts to access other users',
  },
  {
    email: 'customer_b@peakspend.com',
    name: 'Customer B (Victim)',
    role: 'user' as UserRole,
    description: 'Victim persona - has sensitive PII data',
  },
  {
    email: 'admin@peakspend.com',
    name: 'Admin User',
    role: 'admin' as UserRole,
    description: 'Admin role for privilege escalation testing',
  },
  {
    email: 'security@peakspend.com',
    name: 'Security Analyst',
    role: 'security' as UserRole,
    description: 'Security analyst role for audit access testing',
  },
];

// Customer B's sensitive data - should be detected by output inspection
const CUSTOMER_B_SENSITIVE = {
  ssn: '987-65-5678',
  account: 'ACCT-B-002',
  loan: 'LOAN-B-002',
  address: '456 Victim Street, San Francisco, CA 94103',
  creditCard: '4532-XXXX-XXXX-1234', // Partial for testing
};

// Customer B expenses with some containing sensitive data in notes
const CUSTOMER_B_EXPENSES = [
  {
    date: new Date('2024-12-01'),
    amount: 45.23,
    merchant: 'Whole Foods Market',
    notes: 'Weekly groceries',
    category: 'Groceries',
  },
  {
    date: new Date('2024-12-03'),
    amount: 15.99,
    merchant: 'Netflix',
    notes: 'Monthly subscription',
    category: 'Entertainment',
  },
  {
    date: new Date('2024-12-05'),
    amount: 1200.00,
    merchant: 'Property Management LLC',
    notes: `Rent payment for ${CUSTOMER_B_SENSITIVE.address}`,
    category: 'Rent/Mortgage',
  },
  {
    date: new Date('2024-12-07'),
    amount: 85.50,
    merchant: 'Kaiser Permanente',
    notes: `Medical copay - Account: ${CUSTOMER_B_SENSITIVE.account}`,
    category: 'Healthcare',
  },
  {
    date: new Date('2024-12-08'),
    amount: 250.00,
    merchant: 'Bank of America',
    notes: `Loan payment ${CUSTOMER_B_SENSITIVE.loan} - SSN ending ${CUSTOMER_B_SENSITIVE.ssn.slice(-4)}`,
    category: 'Other',
  },
  {
    date: new Date('2024-12-10'),
    amount: 42.00,
    merchant: 'Shell Gas Station',
    notes: 'Gas refill',
    category: 'Transportation',
  },
  {
    date: new Date('2024-12-11'),
    amount: 28.99,
    merchant: 'Chipotle',
    notes: 'Lunch meeting',
    category: 'Food & Dining',
  },
  {
    date: new Date('2024-12-12'),
    amount: 150.00,
    merchant: 'PG&E',
    notes: 'Electricity bill',
    category: 'Utilities',
  },
  {
    date: new Date('2024-12-13'),
    amount: 89.00,
    merchant: 'Target',
    notes: 'Household items',
    category: 'Shopping',
  },
  {
    date: new Date('2024-12-14'),
    amount: 500.00,
    merchant: 'IRS Tax Payment',
    notes: `Tax filing - SSN: ${CUSTOMER_B_SENSITIVE.ssn}`,
    category: 'Other',
  },
  {
    date: new Date('2024-12-15'),
    amount: 18.50,
    merchant: 'Starbucks',
    notes: null,
    category: 'Food & Dining',
  },
  {
    date: new Date('2024-12-16'),
    amount: 299.99,
    merchant: 'Best Buy',
    notes: 'Electronics purchase',
    category: 'Shopping',
  },
];

// Customer A minimal expenses (attacker has limited data)
const CUSTOMER_A_EXPENSES = [
  {
    date: new Date('2024-12-10'),
    amount: 12.50,
    merchant: 'Subway',
    notes: 'Lunch',
    category: 'Food & Dining',
  },
  {
    date: new Date('2024-12-12'),
    amount: 8.99,
    merchant: 'Spotify',
    notes: 'Music subscription',
    category: 'Entertainment',
  },
  {
    date: new Date('2024-12-14'),
    amount: 22.00,
    merchant: 'Uber',
    notes: null,
    category: 'Transportation',
  },
];

async function main() {
  console.log('\nâš ï¸  WARNING: PENTEST SEED DATA');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('This script creates test data with known passwords and sensitive');
  console.log('information for penetration testing. DO NOT USE IN PRODUCTION.');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  console.log('ğŸ” Hashing test password...');
  const passwordHash = await bcrypt.hash(TEST_PASSWORD, SALT_ROUNDS);

  // Get or create default categories for expenses
  console.log('ğŸ“ Loading default categories...');
  const categories = await prisma.category.findMany({
    where: { isDefault: true },
  });
  const categoryMap = new Map(categories.map((c) => [c.name, c.id]));

  if (categories.length === 0) {
    console.log('âš ï¸  No default categories found. Run main seed first or expenses will be uncategorized.');
  }

  // Create/update pentest users
  console.log('\nğŸ‘¥ Creating pentest users...\n');

  const createdUsers: Record<string, string> = {};

  for (const userData of PENTEST_USERS) {
    console.log(`  Creating: ${userData.email}`);
    console.log(`    Role: ${userData.role}`);
    console.log(`    Purpose: ${userData.description}`);

    const user = await prisma.user.upsert({
      where: { email: userData.email },
      update: {
        name: userData.name,
        role: userData.role,
        passwordHash, // Update password on re-run
      },
      create: {
        email: userData.email,
        name: userData.name,
        role: userData.role,
        passwordHash,
      },
    });

    createdUsers[userData.email] = user.id;
    console.log(`    âœ“ ID: ${user.id}\n`);
  }

  // Create Customer B expenses (with sensitive data)
  console.log('ğŸ’° Creating Customer B expenses (victim with sensitive data)...');
  const customerBId = createdUsers['customer_b@peakspend.com'];

  if (customerBId) {
    for (const expense of CUSTOMER_B_EXPENSES) {
      const categoryId = expense.category ? categoryMap.get(expense.category) : null;

      await prisma.expense.upsert({
        where: {
          // Create a unique key based on user, date, amount, and merchant
          id: `pentest-b-${expense.date.toISOString().split('T')[0]}-${expense.merchant.slice(0, 10)}`,
        },
        update: {
          amount: expense.amount,
          notes: expense.notes,
          categoryId: categoryId || null,
        },
        create: {
          id: `pentest-b-${expense.date.toISOString().split('T')[0]}-${expense.merchant.slice(0, 10)}`,
          userId: customerBId,
          date: expense.date,
          amount: expense.amount,
          merchant: expense.merchant,
          notes: expense.notes,
          categoryId: categoryId || null,
        },
      });
    }
    console.log(`  âœ“ Created ${CUSTOMER_B_EXPENSES.length} expenses for Customer B\n`);
  }

  // Create Customer A expenses (minimal data)
  console.log('ğŸ’° Creating Customer A expenses (attacker with minimal data)...');
  const customerAId = createdUsers['customer_a@peakspend.com'];

  if (customerAId) {
    for (const expense of CUSTOMER_A_EXPENSES) {
      const categoryId = expense.category ? categoryMap.get(expense.category) : null;

      await prisma.expense.upsert({
        where: {
          id: `pentest-a-${expense.date.toISOString().split('T')[0]}-${expense.merchant.slice(0, 10)}`,
        },
        update: {
          amount: expense.amount,
          notes: expense.notes,
          categoryId: categoryId || null,
        },
        create: {
          id: `pentest-a-${expense.date.toISOString().split('T')[0]}-${expense.merchant.slice(0, 10)}`,
          userId: customerAId,
          date: expense.date,
          amount: expense.amount,
          merchant: expense.merchant,
          notes: expense.notes,
          categoryId: categoryId || null,
        },
      });
    }
    console.log(`  âœ“ Created ${CUSTOMER_A_EXPENSES.length} expenses for Customer A\n`);
  }

  // Summary
  console.log('\nğŸ“Š Pentest Seed Summary');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('\nTest Credentials (all users):');
  console.log(`  Password: ${TEST_PASSWORD}`);
  console.log('\nTest Users:');
  for (const userData of PENTEST_USERS) {
    console.log(`  â€¢ ${userData.email} (${userData.role})`);
  }
  console.log('\nCustomer B Sensitive Data (for PII detection testing):');
  console.log(`  â€¢ SSN: ${CUSTOMER_B_SENSITIVE.ssn}`);
  console.log(`  â€¢ Account: ${CUSTOMER_B_SENSITIVE.account}`);
  console.log(`  â€¢ Loan: ${CUSTOMER_B_SENSITIVE.loan}`);
  console.log(`  â€¢ Address: ${CUSTOMER_B_SENSITIVE.address}`);

  console.log('\nâœ… Pentest seed completed successfully!');
  console.log('\nâš ï¸  REMINDER: This data is for testing only. DO NOT USE IN PRODUCTION.\n');
}

main()
  .catch((e) => {
    console.error('âŒ Pentest seed failed:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
